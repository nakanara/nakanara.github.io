---
title: 'SOAP 통신'
layout: 
---

## SOAP 통신

JAVA를 이용한 SOAP 통신 방법




```java
    /**
    * SOAP 생성
    **/
    private void createSoap(String data){
        String soapEndPointUrl = "http://example.com/wsdl";    // 접속 SOAP End Point URL
        String soapAction = "soapAction"; // Action
        // String data = "";   // todo json data


        callSoapWebService(soapEndPointUrl, soapAction, data);
    }

    /**
     * SOAP 호출
     **/
    private void callSoapWebService(String soapEndPointUrl, String soapAction, String data) {

        SOAPConnectionFactory soapConnectionFactory = null;
        SOAPConnection soapConnection = null;
        try {

            soapConnectionFactory = SOAPConnectionFactory.newInstance();
            soapConnection = soapConnectionFactory.createConnection();


            // 전달 데이터 생성
            SOAPMessage soapMessage = createSOAPRequest(soapAction, data);

            // 호출
            SOAPMessage soapResponse = soapConnection.call(soapMessage, soapEndPointUrl);

            System.out.println("## Response SOAP Send");
            ByteArrayOutputStream outputStream = new ByteArrayOutputStream();
            soapResponse.writeTo(outputStream); 

            String result = new String(outputStream.toByteArray(), "utf-8");

            System.out.println("## " + result);

            resultParsing(result);

        }catch(SOAPException e) {

        }catch(IOException ioe) {

        } finally {
            if(soapConnection != null) try {
                soapConnection.close();
            }catch(SOAPException e){}
        }
    }

    private SOAPMessage createSOAPRequest(String soapAction, String data) throws SOAPException, IOException{

        MessageFactory messageFactory = MessageFactory.newInstance();
        SOAPMessage soapMessage = messageFactory.createMessage();
        soapMessage.setProperty(SOAPMessage.WRITE_XML_DECLARATION, "true"); // 상단 xml tag

        createSOAPBody(soapMessage, data);

        MimeHeaders headers = soapMessage.getMimeHeaders();
        headers.addHeader("SOAPAction", soapAction);

        soapMessage.saveChanges();  // 출력을 위한, writeTO 호출전 마크 업.

        Log.biz.info("## Request SOAP ");

        try ( ByteArrayOutputStream outputStream = new ByteArrayOutputStream() ){
            soapMessage.writeTo(outputStream);
            Log.biz.info("## Request Log ==" + new String(outputStream.toByteArray(), "utf-8"));

        }catch(IOException e){
            throw new IOException(e);
        }


        return soapMessage;
    }

    private void createSOAPBody(SOAPMessage soapMessage, String data) throws SOAPException {

        SOAPPart soapPart = soapMessage.getSOAPPart();

        String targetNameSpace = "xmlns";
        String targetNameSpaceURI = "http://ezGateWay.ezApproval.Kaoni.com/";

        // SOAP Envelope
        // add Name Space
        SOAPEnvelope soapEnvelope = soapPart.getEnvelope();
        soapEnvelope.addNamespaceDeclaration(targetNameSpace, targetNameSpaceURI);

        // SOAP Body
        SOAPBody soapBody = soapEnvelope.getBody();

        // Custom Node
        SOAPElement mwApprovalDraft = soapBody.addChildElement("mwApprovalDraft");

        SOAPElement docInfo = mwApprovalDraft.addChildElement("docInfo");

        // data add
        docInfo.appendChild(soapBody.getOwnerDocument().createCDATASection(data));


    }

    private String resultParsing(String result){

        ByteArrayInputStream inputStream = null;
        Document document = null;

        try{
            inputStream = new ByteArrayInputStream(result.getBytes("utf-8"));

            document = DocumentBuilderFactory.newInstance().newDocumentBuilder().parse(inputStream);

            NodeList nodeList = document.getElementsByTagName("mwApprovalDraftResult");
            Log.biz.info("## Approval Size = " + nodeList.getLength());

            Node node = nodeList.item(0);

            String text = node.getTextContent();
            Log.biz.info("## Approval Result = " + text);


            return text;
        }catch(ParserConfigurationException | SAXException | IOException e){
            Log.biz.err(e);
        }finally {
            if(inputStream != null) {
                try{
                    inputStream.close();
                }catch(IOException e){

                }
            }
        }

        return null;


    }


}
```

## 참고

* http://www.w3.org/TR/soap/ 
